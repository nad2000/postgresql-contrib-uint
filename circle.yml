machine:
        pre:
        - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
        services:
        - docker

test:
        pre:
        - docker build -t pg-uint .
        - docker run --rm -d --name pguint pg-uint

        override:
        - docker exec pguint psql -U postgres -c "CREATE EXTENSION uint" && echo "SUCCESS"
        - docker exec pguint psql -U postgres -c "CREATE TABLE test(col1 uint1, col2 uint2, col4 uint4);" && echo "SUCCESS"
        - docker exec pguint psql -U postgres -c "INSERT INTO test(col1, col2, col4) SELECT v % 127, v % 16256, v FROM generate_series(1, 1000000) AS d(v)" && echo "SUCCESS"
        - docker exec pguint psql -U postgres -c "INSERT INTO test(col1, col2, col4) SELECT v % 127, v % 16256, v FROM generate_series(1, 1000000) AS d(v)" && echo "SUCCESS"
        post:
        - docker stop pguint

deployment:
        hub:
                branch: /.*/
                commands:
                        - docker login -e $DOCKER_HUB_EMAIL -u $DOCKER_HUB_USER_ID -p $DOCKER_HUB_PWD
                        - docker tag pg-uint $DOCKER_HUB_USER_ID/postgres-uint:$CIRCLE_SHA1
                        - docker tag pg-uint $DOCKER_HUB_USER_ID/postgres-uint:latest
                        - docker push $DOCKER_HUB_USER_ID/postgres-uint:$CIRCLE_SHA1
                        - docker push $DOCKER_HUB_USER_ID/postgres-uint:latest

